# Infinity Project

## 1. О проекте

Infinity Project — это набор микросервисов, реализованных по принципам Clean Architecture. Основная цель проекта — управлять пользователями и их избранными валютами, а также получать актуальный курс валют с Центрального банка России.  

В проекте реализованы следующие сервисы:  

- **Migration Worker** — сервис миграции баз данных PostgreSQL.  
- **Currency Service** — микросервис для работы с валютами, включая управление избранными валютами пользователей, включая фоновый обновляющий сервис,  
- **User Service** — микросервис для управления пользователями (регистрация, логин, логаут).  
- **Gateway API / gRPC** — API Gateway для объединения всех сервисов и предоставления REST/gRPC интерфейсов клиентам.  
Все микросервисы поддерживают **JWT авторизацию**.
---

## 2. Реализованные процессы

### 2.1 Миграции базы данных
- Создание баз данных `UserDb` и `CurrencyDb`.
- Миграции создаются на основе `DbContext` и применяются при старте миграционного сервиса.
- В слоях Infrastructure реализованы фабрики контекстов, для облегчения генерации миграций в режиме Design

### 2.2 Фоновый сервис обновления валют
- Обращается к `http://www.cbr.ru/scripts/XML_daily.asp` каждые 10 минут (по умолчанию).  
- Парсит XML и сохраняет данные в таблицу ` CurrencyDb.currency`.

### 2.3 User Service
- Регистрация новых пользователей.  
- Авторизация (логин) с выдачей JWT.  
- Логаут (stateless).  
- Хранение паролей с хэшированием.

### 2.4 Currency / Favorite Service
- Получение списка избранных валют пользователя.  
- Добавление и удаление валют из избранного.  

### 2.5 API Gateway
- Объединяет все микросервисы под единым REST/gRPC интерфейсом.  
- Поддерживает JWT авторизацию.  
- Прокси для gRPC сервисов.

### 2.6 Unit-тесты
- Есть тесты для User Service, Currency Service (разделено тестирование блока с курсами и избранными валютами).  
- Мокируются внешние зависимости (репозитории, gRPC клиенты, password hasher, JWT сервис).

---

## 3. Как запустить проект через Docker Compose

1. Клонируйте репозиторий:

```bash
git clone <repo_url>
cd <repo_folder>
```

2. Убедитесь, что Docker и Docker Compose установлены.

3. Запуск всех сервисов:

```bash
docker-compose up --build
```

## 4. Сервисы будут доступны на следующих портах:

| Сервис         | Порт  |
|----------------|-------|
| User gRPC      | 8080  |
| Currency gRPC  | 9080  |
| Gateway API    | 30080 |
| Gateway gRPC   | 20080 |
| PostgreSQL     | 5432  |

## 5. Переменные окружения, заданные в `docker-compose.yml`:

- JWT: `Jwt__Secret`, `Jwt__Issuer`, `Jwt__Audience`
- URLs gRPC сервисов: `UrlGrpcMicroservice__User`, `UrlGrpcMicroservice__Currency`
- ASP.NET Core URLs: `ASPNETCORE_URLS`
- Среда: `ASPNETCORE_ENVIRONMENT`
